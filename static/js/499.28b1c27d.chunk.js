"use strict";(self.webpackChunkmy_react_appo=self.webpackChunkmy_react_appo||[]).push([[499],{9499:(r,a,e)=>{e.r(a),e.d(a,{default:()=>A});var o=e(9950),t=e(4857),i=e(6589),s=e(6491),n=e(2053),d=e(226),c=e(4745),l=e(899),u=e(6639),m=e(8429),p=e(7938),x=e(2845),h=e(294),v=e(3849),g=e(4414);const f="miscompras",A=()=>{var r,a;const[e,A]=(0,o.useState)(!0),[y,j]=(0,o.useState)(null),[C,b]=(0,o.useState)([]),[E,w]=(0,o.useState)([]),N=(0,t.A)(),O=(0,i.A)(N.breakpoints.down("sm")),{codigo:R}=(0,m.g)(),S=((null===(r=(0,m.zy)().state)||void 0===r?void 0:r.userName)||"").trim(),k=(0,o.useMemo)((()=>(0,v.aU)(h.A)),[]),M=((0,o.useCallback)((r=>{const a=Number(r||0);if(a<=0)return 0;const e=(a-1500)/1.3;if(e>0&&e<=7e3)return Math.round(e);const o=(a-1e3)/1.22;if(o>7e3&&o<=25e3)return Math.round(o);const t=a/1.15;if(t>25e3&&t<=25e4)return Math.round(t);const i=a/1.12;if(i>25e4&&i<=5e5)return Math.round(i);const s=(a-1e5)/1.08;return Math.round(s)}),[]),(0,o.useCallback)((r=>{const a=Number(r||0);return Math.round(.05*a)}),[]),(null===y||void 0===y?void 0:y.compraEstado)||"Libre"),P=String((null===y||void 0===y?void 0:y.compraCogidaPor)||""),F="Cogida"===M&&P===S,I=String((null===y||void 0===y?void 0:y.Estado)||""),D=String((null===y||void 0===y?void 0:y.Usuario)||"").trim(),L=(0,o.useMemo)((()=>Array.isArray(C)?C.map((r=>String(r).trim())).filter(Boolean):[]),[C]);(0,o.useEffect)((()=>{if(!R)return;A(!0);const r=(0,v.H9)(k,"compras",String(R).trim()),a=(0,v.aQ)(r,(r=>{if(!r.exists())return j(null),b([]),w([]),void A(!1);const a={id:r.id,...r.data()};j(a);const e=Array.isArray(a.Servicios)?a.Servicios:[];b(e.map((r=>String(r).trim())).filter(Boolean)),A(!1)}),(r=>{console.error("Error escuchando compra:",r),A(!1)}));return()=>a()}),[k,R]),(0,o.useEffect)((()=>{(async()=>{if(D)if(L.length)try{w([]);const r=L.map((async r=>{const a=(0,v.H9)(k,"compradores",D,f,r),e=await(0,v.x7)(a);return e.exists()?{id:e.id,...e.data()}:null})),a=(await Promise.all(r)).filter(Boolean);w(a)}catch(r){console.error("Error cargando productos:",r)}else w([]);else w([])})()}),[k,D,L]);const z=(0,o.useCallback)((async()=>{try{if(!R)return;if(!S)return void alert("Falta userName (location.state.userName).");const r=(0,v.H9)(k,"compras",String(R).trim());await(0,v.c4)(k,(async a=>{const e=await a.get(r);if(!e.exists())throw new Error("Compra no existe.");if("Libre"!==((e.data()||{}).compraEstado||"Libre"))throw new Error("Esta compra ya fue cogida por otra vendedora.");a.update(r,{compraEstado:"Cogida",compraCogidaPor:S,compraCogidaAt:(0,v.O5)(),updatedAt:(0,v.O5)()})}))}catch(r){console.error(r),alert((null===r||void 0===r?void 0:r.message)||"No se pudo coger la compra.")}}),[k,R,S]),H=(0,o.useCallback)((async r=>{if(!R)return;if(!D)return void alert("Falta data.Usuario (compradorId).");if(!L.length)return void alert("No hay serviciosIds para actualizar.");const a=(0,v.H9)(k,"compras",String(R).trim()),e=(0,v.wP)(k);e.update(a,{Estado:r,updatedAt:(0,v.O5)()});for(const o of L){const a=(0,v.H9)(k,"compradores",D,f,o);e.update(a,{Estado:r})}await e.commit(),w((a=>a.map((a=>({...a,Estado:r})))))}),[k,R,D,L]),T=(0,o.useCallback)((async()=>{try{if(!S)return void alert("Falta userName (location.state.userName).");if(!R)return;const r=(0,v.H9)(k,"compras",String(R).trim());await(0,v.c4)(k,(async a=>{const e=await a.get(r);if(!e.exists())throw new Error("Compra no existe.");const o=e.data()||{},t=o.compraEstado||"Libre",i=String(o.compraCogidaPor||"");if("Cogida"!==t)throw new Error("La compra no est\xe1 cogida.");if(i!==S)throw new Error("La compra la cogi\xf3 otra vendedora.");a.update(r,{compraCerradaAt:(0,v.O5)(),updatedAt:(0,v.O5)()})})),await H("Comprado")}catch(r){console.error(r),alert((null===r||void 0===r?void 0:r.message)||"No se pudo marcar Comprado.")}}),[k,R,S,H]),B=(0,o.useCallback)((async()=>{try{if(!S)return void alert("Falta userName (location.state.userName).");if(!R)return;const r=(0,v.H9)(k,"compras",String(R).trim());await(0,v.c4)(k,(async a=>{const e=await a.get(r);if(!e.exists())throw new Error("Compra no existe.");const o=e.data()||{},t=o.compraEstado||"Libre",i=String(o.compraCogidaPor||"");if("Cogida"!==t)throw new Error("La compra no est\xe1 cogida.");if(i!==S)throw new Error("La compra la cogi\xf3 otra vendedora.");a.update(r,{compraCerradaAt:(0,v.O5)(),updatedAt:(0,v.O5)()})})),await H("Error")}catch(r){console.error(r),alert((null===r||void 0===r?void 0:r.message)||"No se pudo marcar Error.")}}),[k,R,S,H]),_=(0,o.useCallback)((async()=>{try{if(!S)return void alert("Falta userName (location.state.userName).");if("Comprado"!==I)return void alert("Solo puedes marcar ENVIADO si la compra est\xe1 en COMPRADO.");await H("Enviado")}catch(r){console.error(r),alert((null===r||void 0===r?void 0:r.message)||"No se pudo marcar Enviado.")}}),[S,I,H]),U=(0,o.useCallback)((async()=>{try{if(!S)return void alert("Falta userName (location.state.userName).");if("Enviado"!==I)return void alert("Solo puedes marcar RETIRADO si la compra est\xe1 en ENVIADO.");await H("Retirado")}catch(r){console.error(r),alert((null===r||void 0===r?void 0:r.message)||"No se pudo marcar Retirado.")}}),[S,I,H]);if(e)return(0,g.jsx)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:(0,g.jsx)(u.A,{})});const V=()=>{const r=!S,a="Retirado"===I;return(0,g.jsxs)(s.A,{sx:{p:2,mt:2,border:"1px solid #eee",borderRadius:2},children:[(0,g.jsx)(n.A,{variant:"h6",sx:{mb:1},children:"Gesti\xf3n GLOBAL de la compra"}),(0,g.jsxs)(n.A,{variant:"caption",sx:{display:"block",color:"gray"},children:["Vendedora: ",S||"(sin userName)"," | Candado: ",M,P?" | CogidaPor: ".concat(P):"",I?" | Estado: ".concat(I):""]}),!S&&(0,g.jsx)(n.A,{variant:"body2",sx:{color:"error.main",mt:1},children:"\u26a0\ufe0f Falta userName (location.state.userName)."}),(0,g.jsxs)(s.A,{sx:{display:"flex",gap:1,mt:2,flexWrap:"wrap"},children:[a&&(0,g.jsx)(n.A,{variant:"body2",sx:{color:"success.main",mt:.5},children:"\u2705 Finalizado (RETIRADO)"}),!a&&"Enviado"===I&&(0,g.jsx)(d.A,{variant:"contained",size:"small",onClick:U,disabled:r,children:"RETIRADO"}),!a&&"Comprado"===I&&(0,g.jsx)(d.A,{variant:"contained",size:"small",onClick:_,disabled:r,children:"ENVIADO"}),!a&&"Error"===I&&(0,g.jsx)(n.A,{variant:"body2",sx:{color:"error.main",mt:.5},children:"\u274c Compra marcada como ERROR"}),!a&&"Comprado"!==I&&"Enviado"!==I&&"Error"!==I&&(0,g.jsxs)(g.Fragment,{children:["Libre"===M&&(0,g.jsx)(d.A,{variant:"contained",size:"small",onClick:z,disabled:r,children:"COGER COMPRA"}),"Cogida"===M&&F&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(d.A,{variant:"contained",size:"small",onClick:T,disabled:r,children:"COMPRADO"}),(0,g.jsx)(d.A,{variant:"outlined",size:"small",onClick:B,disabled:r,children:"ERROR"})]}),"Cogida"===M&&!F&&(0,g.jsx)(n.A,{variant:"body2",sx:{color:"warning.main",mt:.5},children:"Compra cogida por otra vendedora (bloqueado)"})]})]}),(0,g.jsx)(c.A,{sx:{mt:2}})]})};return(0,g.jsx)("div",{style:{paddingTop:"10px"},children:(0,g.jsx)(l.Ay,{container:!0,children:O?(0,g.jsxs)("div",{style:{width:"100%"},children:[(0,g.jsx)(x.A,{texto:"Detalles"}),(0,g.jsx)(s.A,{sx:{display:"flex",paddingTop:5,justifyContent:"center"},children:(0,g.jsxs)(l.Ay,{item:!0,xs:10,children:[(0,g.jsx)(V,{}),(0,g.jsx)(p.A,{data:E,enviado:()=>{}})]})})]}):(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(l.Ay,{item:!0,xs:6,children:(0,g.jsx)(s.A,{sx:{p:1,display:"flex",justifyContent:"center"},children:(0,g.jsxs)(l.Ay,{item:!0,xs:10,children:[(0,g.jsx)("h2",{children:"INFORMACION COMPRA \n\nCodigo:".concat(null!==(a=null===y||void 0===y?void 0:y.Fecha)&&void 0!==a?a:""," ")}),(0,g.jsxs)(l.Ay,{container:!0,spacing:2,children:[(0,g.jsx)(l.Ay,{item:!0,xs:6,children:(0,g.jsx)(n.A,{variant:"body1",sx:{color:"gray"},children:"Precio de compra"})}),(0,g.jsx)(l.Ay,{item:!0,xs:6,children:(0,g.jsx)(n.A,{variant:"body1",children:1e3})})]})]})})}),(0,g.jsxs)(l.Ay,{item:!0,xs:6,children:[(0,g.jsx)("h2",{children:"".concat(E.length," PRODUCTOS")}),(0,g.jsxs)(s.A,{sx:{p:2},children:[(0,g.jsx)(V,{}),(0,g.jsx)(p.A,{data:E,enviado:()=>{}})]})]})]})})})}},7938:(r,a,e)=>{e.d(a,{A:()=>l});var o=e(899),t=e(6491),i=e(2053),s=e(3464),n=e(9950),d=e(8429),c=e(4414);const l=function(r){let{data:a,enviado:e,isBuscar:l}=r;const[u,m]=(0,n.useState)(!1),[p,x]=(0,n.useState)(null),h=((0,d.Zp)(),(0,n.useCallback)((r=>{const a=Number(r||0);return Math.round(.05*a)}),[])),v=(0,n.useCallback)((r=>{const a=Number(r||0);if(a<=0)return 0;const e=(a-1500)/1.3;if(e>0&&e<=7e3)return Math.round(e);const o=(a-1e3)/1.22;if(o>7e3&&o<=25e3)return Math.round(o);const t=a/1.15;if(t>25e3&&t<=25e4)return Math.round(t);const i=a/1.12;if(i>25e4&&i<=5e5)return Math.round(i);const s=(a-1e5)/1.08;return Math.round(s)}),[]);return console.log(a),(0,c.jsxs)(c.Fragment,{children:[a.map(((r,a)=>(0,c.jsx)(o.Ay,{container:!0,justifyContent:"center",children:(0,c.jsx)(o.Ay,{item:!0,xs:12,sm:10,children:(0,c.jsxs)(t.A,{display:"flex",alignItems:"center",p:1,borderRadius:8,boxShadow:3,width:"100%",children:[(0,c.jsx)("img",{src:r.Img,alt:"Sample",style:{borderRadius:"30%",width:"100%",maxWidth:"80px",marginRight:"16px"},onClick:()=>{return a=r.Imagen,x(a),void m(!0);var a}}),(0,c.jsxs)("div",{children:[(0,c.jsx)("h3",{children:r.Titulo}),(0,c.jsx)("p",{children:r.Detalles}),(0,c.jsxs)("p",{children:["Precio de compra: ",v(r.Precio)," *  Cantidad ",r.qty," "]}),(0,c.jsxs)("p",{children:["Beneficio: ",h(r.Precio),"  "]}),(0,c.jsx)(i.A,{variant:"body1",component:"a",href:r.link,target:"_blank",rel:"noopener noreferrer",sx:{color:"primary.main",textDecoration:"underline",cursor:"pointer"},children:"Pulsa aqui"})]})]})})},a))),(0,c.jsx)(s.A,{open:u,onClose:()=>{m(!1),x(null)},maxWidth:"lg",children:(0,c.jsx)("div",{style:{backgroundColor:"rgba(0, 0, 0, 0.8)"},children:(0,c.jsx)("img",{src:p,alt:"Enlarged Sample",style:{width:"100%"}})})})]})}}}]);